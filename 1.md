flowchart TB

%% ===== Entry Layer =====
subgraph Entry["Entry & App Layer"]
    DNS["DNS"]
    CDN["CDN / Edge Cache"]
    Client["Client (Web / Mobile / Partner)"]
    LB["Load Balancer"]
    APIGWRead["API Gateway (Read)"]
    APIGWWrite["API Gateway (Write)"]
    AppRead["App Servers (Read)"]
    AppWrite["App Servers (Write)"]
end

%% ===== Data/Search Layer =====
subgraph Data["Data & Search Layer"]
    Postgres["Postgres (Sharded DB)"]
    Redis["Redis (Cache)"]
    Search["OpenSearch / Aggregator"]
    ShardMgr["Shard Manager"]
end

%% ===== Processing Layer =====
subgraph Processing["Processing & Queues"]
    NotifyQ["Notification Queue"]
    NotifySvc["Notification Service"]
    OCRQ["OCR Queue"]
    OCRWorker["OCR Worker"]
    GenQ["Doc Generation Queue"]
    GenWorker["Doc Generation Worker"]
end

%% ===== AI & Integration Layer =====
subgraph AI["AI & Integrations"]
    HSCode["HS Code Classifier"]
    OCRAI["OCR / NLP Extractor"]
    Risk["Risk Scoring"]
    LLM["RAG / LLM Compliance Q&A"]
    Orchestrator["n8n / Temporal"]
    Wrappers["Wrapper SDKs - ICEGATE / DGFT / ULIP / Banks"]
end

%% ===== Security Layer =====
subgraph Security["Security & Auth"]
    Keycloak["Keycloak / OIDC + MFA"]
    OPA["OPA - RBAC / ABAC"]
    WAF["WAF + API Keys"]
    mTLS["mTLS / Service Mesh"]
    Vault["Secrets Manager (Vault / KMS)"]
end

%% ===== Observability Layer =====
subgraph Obs["Observability"]
    OTel["OpenTelemetry (Traces)"]
    Prom["Prometheus (Metrics)"]
    Grafana["Grafana (Dashboards)"]
    Loki["Loki (Logs)"]
    Sentry["Sentry (Errors)"]
end

%% ===== Infra Layer =====
subgraph Infra["Infra & Deployment"]
    K8s["Kubernetes Cluster"]
    CICD["CI/CD (GitHub Actions / ArgoCD)"]
    Storage["S3 / DigitalOcean Spaces"]
    Backup["DR / Backups"]
    Scaling["Auto-scaling"]
end

%% ===== Governance Layer =====
subgraph Gov["Governance & Compliance"]
    Audit["Audit Logs"]
    Consent["Consent & Access Logs"]
    Retention["S3 Lifecycle / Archival"]
    Compliance["GST / ICEGATE / DGFT Compliance"]
end

%% ==== Connections ====

%% Entry connections
Client --> DNS --> CDN --> LB --> APIGWRead --> AppRead
LB --> APIGWWrite --> AppWrite

%% App to Data
AppRead --> Redis
AppRead --> Postgres
AppRead --> Search
AppWrite --> Postgres
AppWrite --> ShardMgr

%% App to Processing
AppWrite --> NotifyQ --> NotifySvc
AppWrite --> OCRQ --> OCRWorker
AppWrite --> GenQ --> GenWorker

%% AI integrations
AppRead --> Orchestrator
AppWrite --> Orchestrator
Orchestrator --> HSCode
Orchestrator --> OCRAI
Orchestrator --> Risk
Orchestrator --> LLM
Orchestrator --> Wrappers

%% Security
APIGWRead --> Keycloak --> OPA --> AppRead
APIGWWrite --> Keycloak --> OPA --> AppWrite
WAF --> LB
mTLS --> AppRead
mTLS --> AppWrite
Vault --> AppRead
Vault --> AppWrite

%% Observability
AppRead --> OTel --> Prom --> Grafana
AppWrite --> OTel
AppRead --> Loki
AppWrite --> Loki
AppRead --> Sentry
AppWrite --> Sentry

%% Infra
AppRead --> K8s
AppWrite --> K8s
K8s --> CICD
K8s --> Storage
K8s --> Backup
K8s --> Scaling

%% Governance
AppWrite --> Audit --> Compliance
AppWrite --> Consent --> Compliance
Storage --> Retention
